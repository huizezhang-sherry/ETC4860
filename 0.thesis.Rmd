---
title: "0.Thesis"
author: "Huize Zhang"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    toc: true
    fig_caption: yes
editor_options: 
  chunk_output_type: console
bibliography: 0.ref_2.bib
csl: apa.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = TRUE)
library(tidyverse)
library(boot)
library(broom)

load("raw_data/au.rda")
```


# Data structure
jhkhkjh 

<!-- \begin{align} -->
<!-- Y_{ijtk} &= \mu + \alpha_i + \beta_j + \gamma_t + \delta_k + CP_2(\alpha_i, \beta_j, \gamma_t, \delta_k) + CP_3(\alpha_i, \beta_j, \gamma_t, \delta_k) \\ -->
<!-- \text{where} \\ -->
<!-- i &\text{ is the judge_id index and } i = 1, 2, \cdots, I \\ -->
<!-- j &\text{ is the video_id index and } j = 1, 2, \cdots, J \\ -->
<!-- t &\text{ is the time index and } t = 1, 2, \cdots, T_J \\ -->
<!-- k &\text{ is the index for the available action unit in this project and } k = 1, 2, \cdots, K \\ -->
<!-- CP_2 & \text{ is the all possible interaction of the two variables}\\ -->
<!-- CP_3 & \text{ is the all possible interaction of the three variables} -->

<!-- \end{align} -->

thisithis i


# Action Unit across judge

Apart from understand how each judge behave consistently or not across all the video, we are also interested in comparing *across* all the judges to study who would appear more animated than others. In this piece of analysis we perform a principle component analysis (PCA) on the whole dataset with the time index being aggregated for each judge and video pair. Mathmetically, the data structure can be summarised as follows. 

\begin{align}
\begin{bmatrix}
x_{1,1,\bar{t},1} & x_{1,1,\bar{t},2} & \cdots & x_{1,1,\bar{t},K}\\
x_{1,2,\bar{t},1} & x_{1,2,\bar{t},2} & \cdots & x_{1,2,\bar{t},K}\\
\vdots & \vdots & &\vdots\\
x_{1,J,\bar{t},1} & x_{1,J,\bar{t},2} & \cdots & x_{1,2,\bar{t},K}\\
x_{2,1,\bar{t},1} & x_{2,1,\bar{t},2} & \cdots & x_{2,1,\bar{t},K}\\
\vdots & \vdots & &\vdots\\
x_{I,J,\bar{t},1} & x_{I,J,\bar{t},2} & \cdots & x_{I,J,\bar{t},K}
\end{bmatrix}
\end{align}

## Result 
The scree plot in Figure \ref{fig:pca_vis} shows that the cummulated variance explained by each prinicple component increase gradually, which suggests the data has a lot of noise. The variable plot in Figure \ref{fig:pca_impt} indicates some important variables that can be summarised into the following table. 

|PC#|Variables|
|---|----------|
|PC1|AU06, AU09, AU17, AU45, AU05|
|PC2|AU04, AU05, AU06, AU09, AU17, AU25|


Visualisation of the first two PCs can be found in Figure \ref{fig:pca_vis}. It shows that the Justices Nettle and Kiefel has high projection on the first principle component and Justices Bell has high projection on the second principle component. 

### Who is the most animated judge
The PCA study can help us to answer the following question: Who is the most animated judge? Since PCs are linear combination of the original variables, @chao2017principal proposed to take the absolute value of the fitted PCs and add them up to create an index to measure [fill in here]. In this study, the first two PCs are added up to determine the most animated judge and find that [concluson]

\newpage

# Appendix 

```{r echo = FALSE}
summarised_mean <- au %>% 
  select(-speaker, -frame_id) %>% 
  group_by(judge_id, video_id) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  filter(AU01_c != "NaN") # four combination have na_prop = 1
  
pca_data <- summarised_mean %>%   
  ungroup() %>%
  select(-judge_id, -video_id)

pca_model <- pca_data %>%
  nest() %>% 
  mutate(model = map(data, ~prcomp(.x)))
```

```{r pca_scree, echo = FALSE, fig.height=4, fig.width=5, fig.align="center", fig.cap="Scree plot for cummulative variance explained by the PCs.\\label{fig:pca_vis}"}
# vis: variance explained: top 10 PCs explains 94.5% of the variance - happy with that
pca_model$model %>%
  map_df(~tidy(.x, data = .y, "pcs")) %>%
  ggplot(aes(x = PC, y = cumulative)) +
  geom_line() +
  geom_point()

pca_aug <- pca_model %>% 
  mutate(pca_aug = map2(model, data, ~augment(.x, data = .y))) %>%
  unnest(pca_aug) %>% 
  bind_cols(summarised_mean[, 1:2]) 
```

```{r pca_impt, echo = FALSE, fig.height = 4, fig.width=5, fig.align="center", fig.cap = "Visualisation of the variable importance in the first two PCs.\\label{fig: pca_impt}"}
# Most important variables
library(factoextra)
fviz_pca_var(prcomp(pca_data),
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
# weight
# pca_model$model[[1]]$rotation %>% 
#   as_tibble() %>% 
#   bind_cols(AU = colnames(pca_data)) %>% 
#   arrange(PC1, PC2) %>% 
#   select(AU, PC1, PC2)
```

```{r pca_vis, echo = FALSE, fig.height=4, fig.width=5, fig.align="center", fig.cap="Visualisation of the first and second principle component.\\label{fig:pca_vis}"}
# PCA vis
pca_aug %>% 
  ggplot(aes(x = .fittedPC1, y = .fittedPC2, col = judge_id)) + 
  geom_point() 
```

```{r most_animated, echo = FALSE, fig.height=4, fig.width=5, fig.align="center", fig.cap = "The most animated judge by adding up the first two principle components.\\label{fig:most_animated}"}
# Most animated judge
most_animated_judge <- pca_aug %>% 
  select(.fittedPC1: .fittedPC10) %>% 
  as.matrix() %>% 
  abs() %>% 
  as.data.frame() %>% 
  bind_cols(judge_id = pca_aug$judge_id, 
            video_id = pca_aug$video_id) %>% 
  group_by(judge_id) %>% 
  summarise_all(mean) %>% # summarise into one judge per row (from one judge*video per row)
  ungroup() %>% 
  mutate(index = select(., .fittedPC1: .fittedPC2) %>% rowSums()) %>% 
  select(judge_id, index) %>% 
  arrange(desc(index))

most_animated_judge %>% 
  ggplot(aes(x = fct_reorder(judge_id, desc(index)), 
             y = index, col = index, fill = index)) + 
  geom_bar(stat = "identity") + 
  xlab("judge") + 
  ggtitle("Who is the most animated judge?")
```

\newpage
# Reference