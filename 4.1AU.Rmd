---
title: "4.1AU"
author: "Huize Zhang"
date: "13/06/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE,message = FALSE, cache = TRUE)

library(tidyverse)
library(naniar)
library(ggpubr)

load("raw_data/court.rda")
load("raw_data/au_tidy.rda")

```


- `AU##_r` measures the intensity of the 17 AUs 
- `AU##_c` measures the present of the 17 AUs

```{r}
# Missing proportion re-visit
missing <- court %>% 
  select(judge_id, frame_id, video_id, x_1) %>% 
  mutate(judge_id = as.factor(judge_id)) %>% 
  group_by(video_id, judge_id) %>% 
  summarise(na_count = sum(is.na(x_1)), 
            count = n(),
            na_prop = na_count/count, 
            data_prop = 1-na_prop)
```

This part checks that at least part of the AU is present with certain intensity
```{r}
# bell2_mod <- au %>% 
#   mutate(AU_c_sum = select(., AU01_c: AU45_c) %>% rowSums(na.rm = TRUE)) %>% 
#   mutate(AU_r_sum = select(., AU01_r: AU45_r) %>% rowSums(na.rm = TRUE)) 
# bell2_mod %>% ggplot(aes(x = frame_id, y = AU_c_sum)) + 
#   geom_point() + 
#   facet_wrap(vars(video_id))
# bell2_mod$AU_r_sum
```

# Count_video_sample

- From count_video_sample, we can know the number of sample we have for appellent and respondent. 

- We can see that the number of sample is different for appellent and respondent in each case, which then motivates us to use a percentage instead of count for number that each Action Unit appears. 

```{r}
count_video_sample <- function(dt){
  dt %>% 
    select(frame_id, video_id, speaker) %>% 
    group_by(video_id, speaker) %>% 
    summarise(count = n()) %>% 
    spread(speaker, count) %>% 
    rowwise() %>% 
    mutate(Total = sum(Appellent + Respondent))
}

# example: overall - for all cases
count_video_sample(au_imputed)

# example: extract one particular judge's appellent/respondent count information 
judge_id = list("Bell","Keane","Kiefel","Gageler","Nettle","Edelman")

df <- map(judge_id, function(judge){
  df <- au_imputed %>% filter(judge_id == judge) %>% count_video_sample})
names(df) <- judge_id

df$Edelman
```


# The most common action units for each judges

<!-- The following allows us to see the percentage of each Action Unit appears given a specific judge, which provides as a baseline normal expression for each judge This normal expression will be compared with the result from `ActionUnitbySpeaker` to identify the case-specific expression for the judges.  -->

<!-- |Judge|The most common Action Units| -->
<!-- |-----|-------------------| -->
<!-- |Bell|AU02, AU09, AU15, AU20, AU25| -->
<!-- |Keane|AU02, AU15, AU20| -->
<!-- |Kiefel|AU02, AU20, AU25, AU45| -->
<!-- |Gageler|AU02, (AU05, AU14, AU15, AU20, AU25)| -->
<!-- |Nettle|(AU01), AU02, (AU07), AU15, AU20| -->
<!-- |Gordon|AU02, AU20| -->
<!-- |Edelman|AU02, (AU20)| -->

<!--   - AU02: raise of eye brow  -->
<!--   - AU15: downward U-shape lip  -->
<!--   - AU20: lips part  -->

<!-- The presence of a single action unit is not sufficient enough to indicate emotion. We need a combination of upper and lower fact AU to define emotion. -->


The plot gives an overview of the presence of all the action unit across all the judge. The statistic each bar represents is the average presence of an action unit for a judge throughout all the video time and it can be written as $$P_{ik} = \frac{\sum_{jt}X_{ijtk}}{\sum_{j = 1}^JT_j}$$. The order of Action unit on the y axis is ranked by the average presence of all the judge, which can be re-presented as $P_{* K}$. 

```{r}
# Because each judge has different numbers of frame available, mean is a better way ,than sum/ count,  to discribe the frequency of occurence. 

most_common <- au_tidy %>% 
  group_by(judge_id,AU) %>% 
  summarise(avg_presence = mean(presence)) %>% 
  filter(avg_presence != "NaN") %>% 
  group_by(judge_id) %>% 
  arrange(-avg_presence) %>% 
  mutate(common = row_number()) %>% 
  mutate(most_common = as_factor(ifelse(common <=5, 1, 0))) 

save(most_common, file = "raw_data/most_common.rda")

most_common %>% 
  ggplot(aes(x =  fct_reorder(AU, avg_presence), y = avg_presence,
         fill = most_common, col = most_common)) + 
  geom_col() +
  xlab("AU") + 
  ylab("Average Presence") + 
  facet_wrap(vars(judge_id)) + 
  coord_flip() + 
  theme(legend.position = "none")

#ggsave(filename = "images/most_common_au.png")
```

The most frequent displayed action unit is highlighed in blue for each judge and summarised in the table below. 

```{r}
# in a table format
knitr::kable(most_common %>% 
  filter(most_common ==1) %>% 
  select(-c(common, most_common, avg_presence)) %>% 
  mutate(index = row_number()) %>% 
  spread(judge_id, AU))
```

It can be seen that some of the action units are common across almost all the judges, these includes 

- AU02 (outer eyebrow raise), 
- AU20 (lip stretcher), 
- AU15 (Lip Corner Depressor) and 
- AU14 (Dimpler)

The table below summarises the judge specific high frequent action units.

```{r}
other_highf <- most_common %>% 
  filter(most_common ==1) %>% 
  select(-c(common, most_common, avg_presence)) %>% 
  filter(!AU %in% c("AU02", "AU20", "AU15", "AU14")) %>% 
  mutate(index = row_number()) %>% 
  spread(index, AU) %>% 
  mutate(`2` = ifelse(is.na(`2`), "/", `2`))

knitr::kable(other_highf)
```

These are the results from inspecting the action units visually and they should also be reflected thorugh the coefficients of the relevant models [see stage 3 modelling].

## More present plots 

Apart from visualising the general presence score for all the action unit, we are also interested in the break down statistics by video.  The statistics being plotted is thus $P_{ijk} = \frac{\sum_{t}X_{ijtk}}{T_j}$ with selected most common four action units. From this plot, it is interesting to know that almost all the judges have more frequent action units on the face for case OKS. This maybe related to the nature of the case... 


```{r}
most_common_subset <- most_common %>% 
  filter(most_common == 1) %>% 
  mutate(index = paste0(judge_id,AU))

more_presence <- au_tidy %>% 
  group_by(judge_id,AU, video_id) %>% 
  summarise(avg_presence = mean(presence)) %>% 
  filter(avg_presence != "NaN") %>% 
  arrange(-avg_presence) %>% 
  mutate(index = paste0(judge_id,AU)) %>% 
  filter(index %in% most_common_subset$index) 
  
more_presence %>% 
  filter(AU %in% c("AU02", "AU14", "AU15", "AU20")) %>% 
  ggplot(aes(x = video_id, y = avg_presence, 
             group = judge_id, col = judge_id)) + 
  geom_line() + 
  geom_point() + 
  facet_wrap(vars(AU),scales = "free_x") + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

```



# Comparing based on tf_idf

The tf_idf practics is not very successful because `idf` is always equal to zero. In the textanalysis, the word appears in some of the book but not others will have a positive idf value, while for the words, say "this", that appear in every book will have an idf = 0 because according to the formula `log(6/6)` (there are 6 books and all contains "this"). 

In our action unit cases, all the action units(words) appears in all the jduges(book), thus all the "words" has an idf = 0. 

```{r eval = FALSE}
load("raw_data/au_imputed_old.rda")
au_imputed_old %>% 
  group_by(judge_id) %>% 
  dplyr::summarize_at(vars(ends_with("_c")), sum, na.rm = TRUE) %>% 
  gather(AU_label, value, -c(judge_id)) %>% 
  separate(AU_label, c("AU", "suffix")) %>%
  select(-suffix) %>% 
  filter(value != "NaN") %>% 
  tidytext::bind_tf_idf(AU, judge_id, value) %>% 
  arrange(desc(tf_idf)) 
```


# Who has the most intensive facial expression?

The plot gives an overview of the action unit intensity of all the judges across all the trails. Each bar-and-whisker represents the intensity of all the action units aggregated on time for a particular judge in a specific case. For example, the first bar-and-whisker in case Nauru_a is created using all the 17 action units of Edelman through out the elapsed time in Nauru_a case. 

In Ekman's 20002 FACS manual, the intensity of Action unit is defined based on five classes: Trace(1), Slight(2), Marked or pronounced(3), Severe or extreme(4) and Maximum(5). From the plot, most of the action units have low intensity (almost zero average and lower than one upper bounds) and this is expected because usually in the court room, judges are expected to behave neutral.

Looking carefully, we can find that Judge Nettle seems to have higher average in all the four cases he appears: Nauru_a&b, Rinehart_a &b and judge Bell doesn't seem to have many intensive expressions as we can see from the relatively small amount of dots in the whisker. 

```{r fig.height=5, fig.width=7}
au_intensity_all <- au_tidy %>% 
  mutate(is_intense = ifelse(intensity >= 2, 1, 0))  

# intensity plot
au_intensity_all %>% 
  ggplot(aes(x = judge_id, y = intensity, color = judge_id)) + 
  geom_boxplot() + 
  facet_wrap(vars(video_id), scales = "free_x") + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1), 
        legend.position = "none")
#ggsave("images/I_overall.png",width = 7, height = 5)  

# the plot magnify the box
au_intensity_all %>% 
  ggplot(aes(x = judge_id, y = intensity, color = judge_id)) + 
  geom_boxplot(coef = 100) + 
  facet_wrap(vars(video_id), scales = "free_x") + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1), 
        legend.position = "none") + 
  scale_y_sqrt()
#ggsave("images/I_sqrt.png",width = 7, height = 5)

```

This plot filters out the points have intensity greater than 2  (at least "slight" as per Ekman) in the previous plot and plot it against time and color by the speaker. It tells us that Edelman, Gageler and Nettle are the judges have stronger emotion that can be detected (since they have more points with intensity greater than 2). Different judges also have different time where they display stronger emotions. For example, Justice Nettle are more likely to have stronger emotion throughout the time when the appellent is speaking but only at the beginning and ending periold when the respondent is speaking.

```{r fig.height=4, fig.width=7}
au_intensity_all %>% filter(is_intense ==1) %>% 
  ggplot(aes(x = frame_id, y = intensity, col = speaker)) + 
  geom_point() +
  facet_wrap(vars(judge_id))
#ggsave("images/is_intense.png", width = 7, height = 5)  

# compute the proportion of action unit that has intensity greater than 1
# au_intensity <- au_intensity_all %>% filter(intensity > 1)
# 
# count <- au_intensity %>% 
#   group_by(judge_id) %>% 
#   summarise(count = n()) 
# 
# total <- au_intensity_all %>% 
#   group_by(judge_id) %>% 
#   summarise(total = n())
# 
# count %>% left_join(total) %>% 
#   mutate(proportion = count/total*100)
```

## More intensity plot 1

Apart from visualising the general intensity score for all the action unit, we are also interested in the intensity score of the most frequent units. The statistics being plotted is thus $I_{ij*k}$ with selected $i$ indicated by the `most_common` table above. Five most frequent action units for each of the six judges give 30 subplots and I arrange them into two seperate plots: Intensity for four major high frequent action units and Intensity for other high frequent action units. 

From the first plot, some panels are empty for some judges. This is because the particular action unit is not the most frequent five for that particular judge. We can learn that AU02, although being commonly detected for all the judges, the intensity is quite low. 

From the second plot, most of the intensity are low as the general intensity plot, while one action unit has drawn the attention: AU45 for Kiefel. The intensity in both case parkes and case Rinehart_a for Kiefel are relatively higher than others and this will be reflected through our model. 

```{r}
most_common_subset <- most_common %>% 
  filter(most_common == 1) %>% 
  mutate(index = paste0(judge_id,AU))

intensity_subset <- au_intensity_all %>% 
  mutate(index = paste0(judge_id,AU)) %>% 
  filter(index %in% most_common_subset$index) 

# plot for four major high frequent action units
intensity_subset %>% 
  filter(AU %in% c("AU02", "AU14", "AU15", "AU20")) %>% 
  ggplot(aes(x = video_id, y = intensity, col = video_id)) + 
  geom_boxplot() + 
  facet_grid(rows = vars(AU),
             cols = vars(judge_id), scales = "free_x") + 
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 30, hjust = 1))

# plot for other high frequent action units
intensity_subset_plot <- function(judge){
  intensity_subset %>% 
    filter(!AU %in% c("AU02", "AU14", "AU15", "AU20")) %>% 
    filter(judge_id == judge) %>% 
    ggplot(aes(x = video_id, y = intensity, col = video_id)) + 
    geom_boxplot() + 
    facet_grid(rows = vars(judge_id),
               cols = vars(AU), scales = "free_x") + 
    ylim(c(0,4)) + 
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1))
}

  
judge <- unique(intensity_subset$judge_id)
subplot <- map(judge, intensity_subset_plot)  


ggarrange(subplot[[1]], 
          subplot[[2]],
          subplot[[5]],
          subplot[[6]],
          subplot[[3]],
          subplot[[4]],
          ncol = 2, nrow = 3)

```

## More intensity plot 2

We compute a similar mean intensity score for each of the action unit for each of the judge, the statsitics is $$I_{ik} = \frac{\sum_{jt}X_{ijtk}}{\sum_{j = 1}^JT_j}$$. Less uniform as the mean presence plot - different judge response intense at different action units. 

```{r}
au_intensity_all %>% 
  filter(!AU == "AU28") %>%  # AU28 doesnt have intensity score
  group_by(judge_id, AU) %>% 
  summarise(mean_intensity = mean(intensity, na.rm = TRUE)) %>% 
  arrange(-mean_intensity) %>% 
  mutate(index = row_number(), 
         most_intense = as.factor(ifelse(index <= 5, 1,0))) %>% 
  ggplot(aes(x = fct_reorder(AU, mean_intensity), 
             y = mean_intensity, 
             fill = most_intense)) + 
  geom_col() + 
  facet_wrap(vars(judge_id)) + 
  coord_flip()
```


# Action Unit by frame(time) - not much findings

```{r eval = FALSE}
aubyframe <- function(judge, video){
  au %>% 
  select(AU01_r:AU45_r, judge_id : speaker) %>% 
  gather(AU, value, -(judge_id: speaker)) %>% 
  filter( 
         judge_id == judge, 
         video_id == video, 
         AU %in% c("AU01_r","AU02_r", 
                   "AU05_r","AU07_r",
                   "AU14_r","AU15_r",
                   "AU20_r","AU25_r")) %>% 
  ggplot(aes(x = frame_id, y = value)) +
    geom_vline(xintercept = 80) +  # suppose to be a separate for speakers
  geom_line() + 
    geom_smooth(span = 0.1, se = FALSE) + 
  facet_wrap(vars(AU)) 
}

aubyframe("Nettle", "Nauru_a")



```

Empirical Bayes
  - gene: generally small, a small increase
  - each time is a gene: test if it is normal, sig high 
  - but in this case, we lose time dependence - need to think about it: jump detection/ structural break

# Does it make any difference when the speaking party is different?

This function plot the percentage of each Action Unit appears by case and speakers. It is helpful to compare the difference in the expression of a specific judge between appellent and respondent's speaking time. 

oddstream: Dilini - has a paper 
- we need a method to pull out those structural break


<!-- In case McKell, when respondent is speaking, more frequent appearance of AU20, less frequent appearance of AU25, AU05, AU04 and AU02. These AUs indicate the movement of lips(AU25) and eyebrow(AU02, 04, 05) and we can say Justices Bell has more emotions when the appellent is speaking.  -->

<!-- However, notice that the data we have for appellent are towards the end of the appellent talking time while for respondent it is the beginnning of respondent talking time, thus this could be due to the difference between statement/ Q&A period.  -->

<!-- More: we know that Justices Bell is the Chief Justices in McKell and she has asked way more questions than other three justices. If we would be able to get the time when Justices Bell is asking questions from the transcript, we can see if the emtions she displayed during the appellent speaking period is because of the fact that she is more engaging in the conversation via asking questions.  -->



```{r eval = FALSE}
ActionUnitbySpeaker <- function(dt, judge, case = case_list){
 
  case_list <- c("Nauru_a", "Nauru_b", "McKell", "OKS", "Parkes","Rinehart_a", "Rinehart_b")
  case_cand <- intersect(case_list, case)
  
  sample <- dt %>% 
    filter(judge_id == judge) %>%
    count_video_sample() %>% 
    filter(Total > 10) 
  
  if (all(case_cand %in% sample$video_id)){
    case <- case_cand
  }else{
    case <- case_cand[which(case_cand %in% sample$video_id)]
  }
  
  #browser()
  
  diff <- setdiff(case_cand, sample$video_id) 
  if (length(diff) > 0){
    warning(sprintf("\n %s has less than 10 frames, so it is dropped", diff))
  }

  dt %>% 
    filter(judge_id == judge, 
           video_id %in% case) %>% 
    group_by(speaker, video_id) %>% 
    dplyr::summarize_at(vars(
                             AU45_c, AU09_c, AU06_c, AU17_c, AU04_c), 
                        mean, na.rm = TRUE) %>% 
    gather(AU_label, value, -c(speaker, video_id)) %>% 
    separate(AU_label, c("AU", "suffix")) %>%
    select(-suffix) %>%
    ggplot(aes(x = fct_reorder(AU, value), 
               y = value, col = value, fill = value)) +
    geom_bar(stat = "identity") +
    facet_grid(speaker ~ video_id, scales = "free")+
    ylab("Count") +
    #scale_x_discrete(labels = function(x) word(x, start = 1, sep = "_")) + 
    scale_y_continuous(breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)) +
    coord_flip() +
    ggtitle(sprintf("The percentage of each Action Unit appears in the face of Justices %s", judge))

}

ActionUnitbySpeaker(au_imputed, "Keane")
ActionUnitbySpeaker(au_imputed, "Kiefel", case = c("Parkes", "Rinehart_a"))
ActionUnitbySpeaker(au_imputed, "Bell", case = c("OKS", "McKell"))
ActionUnitbySpeaker(au_imputed, "Gageler")
ActionUnitbySpeaker(au_imputed, "Nettle")
ActionUnitbySpeaker(au_imputed, "Edelman")

au_imputed %>% 
  group_by(judge_id, speaker, video_id) %>% 
  dplyr::summarize_at(vars(ends_with("c")), mean, na.rm = TRUE) %>% 
  gather(AU_label, value, -c(speaker, video_id)) %>% 
  separate(AU_label, c("AU", "suffix")) %>%
  select(-suffix) %>%
  ggplot(aes(x = fct_reorder(AU, value), 
             y = value, col = value, fill = value)) +
  geom_bar(stat = "identity") +
  facet_grid(speaker ~ video_id, scales = "free")+
  ylab("Count") +
  coord_flip()
    

```


Some judges have stronger emotion display in some cases while others i.e. Justices Keane, Kiefel, Gordon and Bell present neutral faces in all the cases collected. Justices Nettle has greater discrepency in his facial expression when the speaking party is difference. Particularly,  in case Nauru_b, he has more emotion displayed when the respondent is speaking and this also happens in case Rinehart_b for Justices Gagele. 

```{r eval = FALSE}
case_list <- c("Nauru_a", "Nauru_b", "McKell", "OKS", "Parkes","Rinehart_a", "Rinehart_b")

count <- au_imputed %>% 
  filter(video_id %in% case_list) %>% 
  group_by(judge_id,video_id) %>% 
  dplyr::summarise(count = n()) %>% 
  filter(count > 10)
  
by_speaker <- au_imputed %>% 
  filter(video_id %in% case_list) %>% 
  group_by(judge_id,speaker, video_id) %>%
  semi_join(count) %>% 
  dplyr::summarize_at(vars(AU01_c:AU45_c), mean, na.rm = TRUE) %>% 
  gather(AU, value, -speaker, -video_id, -judge_id) %>% 
  spread(speaker, value) %>% 
  rowwise() %>% 
  mutate(diff = Appellent - Respondent) %>% 
  ungroup() %>% 
  mutate(presence = as.factor(ifelse(abs(diff)>0.2, 
                                     ifelse(diff > 0, "Appellent",
                                            "Respondent"), "NA"))) 

by_speaker %>% 
  ggplot(aes(x = video_id, y = AU)) +
  geom_tile(aes(fill = presence)) +
  facet_wrap(vars(judge_id),scale = "free") +
  scale_fill_manual(values = c("Appellent" = "#E69F00",
                               "Respondent" = "#5aae61",
                               "NA" = "grey"))

# by_speaker %>% 
#   ggplot(aes(x = AU, y = diff)) +
#   geom_bar(stat = "identity", position = "identity", aes(fill = diff, group = video_id)) +
#   facet_wrap(vars(judge_id, scale = "free")) +
#   coord_flip()


```




