---
chapter: 3
knit: "bookdown::render_book"
---

# Exploratory Data Analysis

## Data Structure

The $Y$ variable in our case is multivariate including `Presence` and `Intensity` and it can be written in matrix notation as 


\begin{align}
Y_{jitk} = 
\begin{bmatrix}
P_{ijtk} \\
I_{ijtk}
\end{bmatrix}
\end{align}


There are four layers of indexs, which are defined as follows 

- $i$ for `judge_id` and $i = 1,2, \cdots, 6$
- $j$ for `video_id` and $j = 1,2, \cdots, 7$
- $t$ for `frame_id` and $t = 1,2, \cdots, T_j$
- $k$ for `au_id` and available action unit includes `r unique(au_tidy$AU)`. Notice that OpenFace doesnt provide intensity score for AU28. 

[this may belong to the modelling part]
Assuming all the facial information can be summarised as a `Y` variable with multiple indices $(i,j,t,k)$. We can summarise the information via a linear combination of variables as 

$$Y_{ijtk} = \mu + \alpha_i + \beta_j + \gamma_t + \delta_k + CP_2(\alpha_i, \beta_j, \gamma_t, \delta_k) + CP_3(\alpha_i, \beta_j, \gamma_t, \delta_k)$$

where 

- $CP_2$ is the all possible interaction of the two variables
- $CP_3$ is the all possible interaction of the three variables


## Action unit: Presence
 
 
### Mean presence 

The plot gives an overview of the presence of all the action unit across all the judge. The statistic each bar represents is the average presence of an action unit for a judge throughout all the video time and it can be written as $$P_{ik} = \frac{\sum_{jt}X_{ijtk}}{\sum_{j = 1}^JT_j}$$. The order of Action unit on the y axis is ranked by the average presence of all the judge, which can be re-presented as $P_{* K}$. 

```{r}
# Because each judge has different numbers of frame available, mean is a better way ,than sum/ count,  to discribe the frequency of occurence. 

load("data/au_tidy.rda")

most_common <- au_tidy %>% 
  group_by(judge_id,AU) %>% 
  summarise(avg_presence = mean(presence)) %>% 
  filter(avg_presence != "NaN") %>% 
  group_by(judge_id) %>% 
  arrange(-avg_presence) %>% 
  mutate(common = row_number()) %>% 
  mutate(most_common = as_factor(ifelse(common <=5, 1, 0))) 

most_common %>% 
  ggplot(aes(x =  fct_reorder(AU, avg_presence), y = avg_presence,
         fill = most_common, col = most_common)) + 
  geom_col() +
  xlab("AU") + 
  ylab("Average Presence") + 
  facet_wrap(vars(judge_id)) + 
  coord_flip() + 
  theme(legend.position = "none")

#ggsave(filename = "images/most_common_au.png")
```

The most frequent displayed action unit is highlighed in blue for each judge and summarised in the table below. 

```{r}
# in a table format
knitr::kable(most_common %>% 
  filter(most_common ==1) %>% 
  select(-c(common, most_common, avg_presence)) %>% 
  mutate(index = row_number()) %>% 
  spread(judge_id, AU))
```

It can be seen that some of the action units are common across almost all the judges, these includes 

- AU02 (outer eyebrow raise), 
- AU20 (lip stretcher), 
- AU15 (Lip Corner Depressor) and 
- AU14 (Dimpler)

The table below summarises the judge specific high frequent action units.

```{r}
other_highf <- most_common %>% 
  filter(most_common ==1) %>% 
  select(-c(common, most_common, avg_presence)) %>% 
  filter(!AU %in% c("AU02", "AU20", "AU15", "AU14")) %>% 
  mutate(index = row_number()) %>% 
  spread(index, AU) %>% 
  rename(first = `1`, second = `2`) 
  

knitr::kable(other_highf)
```

These are the results from inspecting the action units visually and they should also be reflected thorugh the coefficients of the relevant models [see stage 3 modelling]. 

### Presence by videos

Apart from visualising the general presence score for all the action unit, we are also interested in the break down statistics by video.  The statistics being plotted is thus $$P_{ijk} = \frac{\sum_{t}X_{ijtk}}{T_j}$$ with selected most common four action units. From this plot, it is interesting to know that almost all the judges have more frequent action units on the face for case OKS. This maybe related to the nature of the case... 


```{r}
most_common_subset <- most_common %>% 
  filter(most_common == 1) %>% 
  mutate(index = paste0(judge_id,AU))

more_presence <- au_tidy %>% 
  group_by(judge_id,AU, video_id) %>% 
  summarise(avg_presence = mean(presence)) %>% 
  filter(avg_presence != "NaN") %>% 
  arrange(-avg_presence) %>% 
  mutate(index = paste0(judge_id,AU)) %>% 
  filter(index %in% most_common_subset$index) 
  
more_presence %>% 
  filter(AU %in% c("AU02", "AU14", "AU15", "AU20")) %>% 
  ggplot(aes(x = video_id, y = avg_presence, 
             group = judge_id, col = judge_id)) + 
  geom_line() + 
  geom_point() + 
  facet_wrap(vars(AU),scales = "free_x") + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

```


## Action unit: Intensity

### General Intensity  plot

The plot gives an overview of the action unit intensity of all the judges across all the trails. Each bar-and-whisker represents the intensity of all the action units aggregated on time for a particular judge in a specific case. For example, the first bar-and-whisker in case Nauru_a is created using all the 17 action units of Edelman through out the elapsed time in Nauru_a case. In mathematics notation, the plotted statistics is $I_{ijtk}$ seperating by $i \text{and} j$. 

In Ekman's 20002 FACS manual, the intensity of Action unit is defined based on five classes: Trace(1), Slight(2), Marked or pronounced(3), Severe or extreme(4) and Maximum(5). From the plot, most of the action units have low intensity (almost zero average and lower than one upper bounds) and this is expected because usually in the court room, judges are expected to behave neutral. From this plot, we can see that Judge Bell doesn't seem to have many intensive expressions as we can see from the relatively small amount of dots in the whisker.  

To better look at the mean of each boxplot, we take a square root transformation and hide the outliners into the upper line. We can find that Judge Nettle seems to have higher average in all the four cases he appears: Nauru_a&b, Rinehart_a &b. 

```{r}
au_intensity_all <- au_tidy %>% 
  mutate(is_intense = ifelse(intensity >= 2, 1, 0))  

# intensity plot
au_intensity_all %>% 
  ggplot(aes(x = judge_id, y = intensity, color = judge_id)) + 
  geom_boxplot() + 
  facet_wrap(vars(video_id), scales = "free_x") + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1), 
        legend.position = "none")
#ggsave("images/I_overall.png",width = 7, height = 5)  

# the plot magnify the box
au_intensity_all %>% 
  ggplot(aes(x = judge_id, y = intensity, color = judge_id)) + 
  geom_boxplot(coef = 100) + 
  facet_wrap(vars(video_id), scales = "free_x") + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1), 
        legend.position = "none") + 
  scale_y_sqrt()
#ggsave("images/I_sqrt.png",width = 7, height = 5)

``` 
 
### Mean intensity 

We compute a similar mean intensity score for each of the action unit for each of the judge, the statsitics is $$I_{ik} = \frac{\sum_{jt}X_{ijtk}}{\sum_{j = 1}^JT_j}$$. Less uniform as the mean presence plot - different judge response intense at different action units. 

```{r}
au_intensity_all %>% 
  filter(!AU == "AU28") %>%  # AU28 doesnt have intensity score
  group_by(judge_id, AU) %>% 
  summarise(mean_intensity = mean(intensity, na.rm = TRUE)) %>% 
  arrange(-mean_intensity) %>% 
  mutate(index = row_number(), 
         most_intense = as.factor(ifelse(index <= 5, 1,0))) %>% 
  ggplot(aes(x = fct_reorder(AU, mean_intensity), 
             y = mean_intensity, 
             fill = most_intense)) + 
  geom_col() + 
  facet_wrap(vars(judge_id)) + 
  coord_flip()
```  
 
### Intensity plot for the most frequent action units
 
Apart from visualising the general intensity score for all the action unit, we are also interested in the intensity score of the most frequent units. The statistics being plotted is thus $I_{ij*k}$ with selected $i$ indicated by the `most_common` table above. Five most frequent action units for each of the six judges give 30 subplots and I arrange them into two seperate plots: Intensity for four major high frequent action units and Intensity for other high frequent action units. 

From the first plot, some panels are empty for some judges. This is because the particular action unit is not the most frequent five for that particular judge. We can learn that AU02, although being commonly detected for all the judges, the intensity is quite low. 

From the second plot, most of the intensity are low as the general intensity plot, while one action unit has drawn the attention: AU45 for Kiefel. The intensity in both case parkes and case Rinehart_a for Kiefel are relatively higher than others and this will be reflected through our model. 

```{r}
most_common_subset <- most_common %>% 
  filter(most_common == 1) %>% 
  mutate(index = paste0(judge_id,AU))

intensity_subset <- au_intensity_all %>% 
  mutate(index = paste0(judge_id,AU)) %>% 
  filter(index %in% most_common_subset$index) 

# plot for four major high frequent action units
intensity_subset %>% 
  filter(AU %in% c("AU02", "AU14", "AU15", "AU20")) %>% 
  ggplot(aes(x = video_id, y = intensity, col = video_id)) + 
  geom_boxplot() + 
  facet_grid(rows = vars(AU),
             cols = vars(judge_id), scales = "free_x") + 
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 30, hjust = 1))

# plot for other high frequent action units
intensity_subset_plot <- function(judge){
  intensity_subset %>% 
    filter(!AU %in% c("AU02", "AU14", "AU15", "AU20")) %>% 
    filter(judge_id == judge) %>% 
    ggplot(aes(x = video_id, y = intensity, col = video_id)) + 
    geom_boxplot() + 
    facet_grid(rows = vars(judge_id),
               cols = vars(AU), scales = "free_x") + 
    ylim(c(0,4)) + 
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1))
}

  
judge <- unique(intensity_subset$judge_id)
subplot <- map(judge, intensity_subset_plot)  


ggarrange(subplot[[1]], 
          subplot[[2]],
          subplot[[5]],
          subplot[[6]],
          subplot[[3]],
          subplot[[4]],
          ncol = 2, nrow = 3)

```
 
### High intensity points

We filter out the points have intensity greater than 2  (at least "slight" as per Ekman) in the previous plot and plot it against time and color by the speaker. It tells us that Edelman, Gageler and Nettle are the judges have stronger emotion that can be detected (since they have more points with intensity greater than 2). Different judges also have different time where they display stronger emotions. For example, Justice Nettle are more likely to have stronger emotion throughout the time when the appellant is speaking but only at the beginning and ending period when the respondent is speaking.

```{r}
au_intensity_all %>% filter(is_intense ==1) %>% 
  ggplot(aes(x = frame_id, y = intensity, col = speaker)) + 
  geom_point() +
  facet_wrap(vars(judge_id))
```

